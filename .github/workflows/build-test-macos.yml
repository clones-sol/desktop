name: Build Test Application - macOS

on:
  push:
    branches: [ main, change-project-archi ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  FLUTTER_VERSION: '3.29.3'
  TAURI_CLI_VERSION: '2.1.0'

jobs:
  build-test-macos:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            artifact_name: 'desktop-app-macos-arm64'
            target: 'aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            artifact_name: 'desktop-app-macos-x64'
            target: 'x86_64-apple-darwin'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Validate environment
        shell: bash
        run: |
          echo "ðŸ” Validating environment..."
          
          # Verify that the secret exists
          if [ -z "${{ secrets.ENV_FILE_TEST }}" ]; then
            echo "âŒ ENV_FILE_TEST secret is not set"
            exit 1
          fi
          
          # Verify that the essential files exist
          if [ ! -f "pubspec.yaml" ]; then
            echo "âŒ pubspec.yaml not found"
            exit 1
          fi
          
          if [ ! -f "src-tauri/Cargo.toml" ]; then
            echo "âŒ src-tauri/Cargo.toml not found"
            exit 1
          fi
          
          if [ ! -f "src-tauri/tauri.test.conf.json" ]; then
            echo "âŒ src-tauri/tauri.test.conf.json not found"
            exit 1
          fi
          
          echo "âœ… Environment validation complete"

      - name: Create .env file from secrets
        shell: bash
        run: |
          echo "${{ secrets.ENV_FILE_TEST }}" > .env
          echo "âœ… Created .env file from secrets"

      - name: Install dependencies
        shell: bash
        run: |
          echo "ðŸ“¦ Installing Flutter dependencies..."
          flutter pub get
          
          echo "ðŸ“¦ Installing Rust dependencies..."
          cd src-tauri && cargo fetch
          
          echo "ðŸ“¦ Installing Tauri CLI..."
          cargo install tauri-cli --version "${{ env.TAURI_CLI_VERSION }}" --locked
          
          echo "âœ… All dependencies installed"

      - name: Setup macOS build tools
        shell: bash
        run: |
          echo "ðŸ”§ Setting up macOS build tools..."
          
          # Check if create-dmg is available
          if ! command -v create-dmg &> /dev/null; then
            echo "ðŸ“¦ Installing create-dmg..."
            brew install create-dmg || echo "create-dmg not available via brew, continuing..."
          fi
          
          # Check if hdiutil is available (should be built-in)
          if ! command -v hdiutil &> /dev/null; then
            echo "âŒ hdiutil not found - this is required for DMG creation"
            exit 1
          fi
          
          echo "âœ… macOS build tools ready"

      - name: Build Flutter Web
        shell: bash
        run: |
          echo "ðŸŒ Building Flutter Web..."
          flutter build web --release
          
          # Check if the web build exists
          if [ ! -d "build/web" ]; then
            echo "âŒ Flutter web build failed - build/web directory not found"
            exit 1
          fi
          
          echo "âœ… Flutter Web build complete"

      - name: Prepare build directory for Tauri
        shell: bash
        run: |
          echo "ðŸ“ Preparing build directory for Tauri..."
          
          # Create the web directory if it doesn't exist
          mkdir -p web
          
          # Copy the web build to the web directory for Tauri
          cp -r build/web/* web/
          
          # Verify that the files have been copied
          if [ ! -f "web/index.html" ]; then
            echo "âŒ Failed to prepare web directory - index.html not found"
            exit 1
          fi
          
          echo "âœ… Prepared build directory for Tauri"

      - name: Build Tauri application (unsigned)
        shell: bash
        run: |
          echo "ðŸ”¨ Building Tauri application for ${{ matrix.platform }}..."
          cd src-tauri
          
          # Build with error handling
          if ! cargo tauri build ${{ matrix.args }} --config tauri.test.conf.json; then
            echo "âŒ Tauri build failed"
            exit 1
          fi
          
          echo "âœ… Tauri build complete for ${{ matrix.platform }}"

      - name: Debug build output
        shell: bash
        run: |
          echo "ðŸ” Debug: Checking build output..."
          
          # Show the target directory structure
          if [[ "${{ matrix.args }}" == *"aarch64"* ]]; then
            TARGET_DIR="src-tauri/target/aarch64-apple-darwin/release"
          else
            TARGET_DIR="src-tauri/target/x86_64-apple-darwin/release"
          fi
          
          echo "ðŸ“ Target directory: $TARGET_DIR"
          if [ -d "$TARGET_DIR" ]; then
            echo "ðŸ“ Contents of target directory:"
            ls -la "$TARGET_DIR"
            
            if [ -d "$TARGET_DIR/bundle" ]; then
              echo "ðŸ“ Contents of bundle directory:"
              ls -la "$TARGET_DIR/bundle"
              
              # Show contents of each subdirectory
              for subdir in "$TARGET_DIR/bundle"/*; do
                if [ -d "$subdir" ]; then
                  echo "ðŸ“ Contents of $(basename "$subdir"):"
                  ls -la "$subdir"
                fi
              done
            fi
          else
            echo "âŒ Target directory not found"
          fi

      - name: Find built application
        id: find-app
        shell: bash
        run: |
          echo "ðŸ” Searching for built applications..."
          
          # Define the search directory based on target
          if [[ "${{ matrix.args }}" == *"aarch64"* ]]; then
            BUNDLE_DIR="src-tauri/target/aarch64-apple-darwin/release/bundle"
          else
            BUNDLE_DIR="src-tauri/target/x86_64-apple-darwin/release/bundle"
          fi
          
          # Search for .dmg first (preferred), then .app, then .zip
          APP_PATH=$(find "$BUNDLE_DIR" -name "*.dmg" | head -1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find "$BUNDLE_DIR" -name "*.app" -type d | head -1)
          fi
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find "$BUNDLE_DIR" -name "*.zip" | head -1)
          fi
          
          # Verify that we found something
          if [ -n "$APP_PATH" ] && [ -e "$APP_PATH" ]; then
            echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
            echo "âœ… Found application at: $APP_PATH"
            
            # Display the file info and size
            echo "ðŸ“ File details:"
            ls -la "$APP_PATH"
            
            echo "ðŸ“ File size:"
            du -h "$APP_PATH"
            
            # For macOS, also check if it's a DMG and show its contents
            if [[ "$APP_PATH" == *.dmg ]]; then
              echo "ðŸ” DMG contents preview:"
              hdiutil info "$APP_PATH" 2>/dev/null || echo "Could not read DMG info"
            fi
            
          else
            echo "âŒ No application found"
            echo "ðŸ” Debug: Available files in bundle directories:"
            find src-tauri/target -name "bundle" -type d -exec find {} -name "*.app" -o -name "*.dmg" -o -name "*.zip" \; 2>/dev/null || echo "No applications found"
            
            # Show all files in bundle directories for debugging
            echo "ðŸ” All files in bundle directories:"
            find src-tauri/target -name "bundle" -type d -exec ls -la {} \; 2>/dev/null || echo "No bundle directories found"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success() && steps.find-app.outputs.app_path
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ steps.find-app.outputs.app_path }}
          retention-days: 7
          compression-level: 6

      - name: Upload web build
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: web-build-macos-${{ matrix.target }}
          path: build/web/
          retention-days: 7
          compression-level: 6

      - name: Show build summary
        shell: bash
        run: |
          echo ""
          echo "ðŸŽ‰ ===== BUILD SUMMARY ====="
          echo "Platform: ${{ matrix.platform }}"
          echo "Target: ${{ matrix.target }}"
          echo "Artifact: ${{ matrix.artifact_name }}"
          echo "Web build: web-build-macos-${{ matrix.target }}"
          
          if [ -n "${{ steps.find-app.outputs.app_path }}" ]; then
            echo "App location: ${{ steps.find-app.outputs.app_path }}"
            
            # Display the file size
            du -h "${{ steps.find-app.outputs.app_path }}"
          fi
          
          echo "=========================="
          echo "" 